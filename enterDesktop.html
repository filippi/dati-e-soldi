<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dati e soldi AR</title>
    <style>
      /* Style for the invisible overlay button */
      #crosshair-button {
        position: absolute;
        top: 50%;
        left: 50%;
        width: 60px; /* Adjust size as needed */
        height: 60px;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0); /* Fully transparent */
        border: none;
        outline: none;
        z-index: 1000; /* Ensure it's on top */
        cursor: pointer;
      }

      /* Optional: Visual feedback for touch interactions */
      #crosshair-button:active {
        background: rgba(255, 255, 255, 0.1);
      }
    </style>
    <!-- A-Frame and other scripts -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://unpkg.com/aframe-terrain-model-component@1.0.1/dist/aframe-terrain-model-component.min.js"></script>
    <script src="https://unpkg.com/cytoscape/dist/cytoscape.min.js"></script>
    <script id="data-script" src="js/network.js" data-edges-path="sample_data/edges.json" data-nodes-path="sample_data/nodes.json"></script>
    <script src="js/ARData.js"></script>    
    <script src="js/ar-flow-components.js"></script>
    <script src="js/ar-flow.js"></script>
    <script>
      // This function prints the position from the entity with movement-controls and the rotation from the camera
      function printPosAndRot() {
        var movementControlEntity = document.querySelector('[movement-controls]');
        var cameraEl = document.querySelector('a-camera') || document.querySelector('[camera]');
        
        if (movementControlEntity && cameraEl) {
          var position = movementControlEntity.getAttribute('position');
          var rotation = cameraEl.getAttribute('rotation');
          console.log(`<a-entity movement-controls="fly: true; speed: 10" position="${position.x} ${position.y} ${position.z}" rotation="${rotation.x} ${rotation.y} ${rotation.z}" look-controls>
  <a-entity camera position="0 0 0" rotation="0 0 0" look-controls></a-entity>
  </a-entity>`);
        } else {
          console.error('Required entities not found');
        }
      }

      document.addEventListener('DOMContentLoaded', function() {
        var sceneEl = document.getElementById('flowview');
        sceneEl.addEventListener('loaded', function() {
          
          var flowTracerComponent = document.getElementById('surface-current').components['flow-tracer'];
          
          console.log("Flow ", flowTracerComponent);
          var TLab = document.getElementById('timeLabel').components['text-info'];
          flowTracerComponent.setTextTracker(TLab);
          TLab.update_credits(" [p]Pause [m]Mode [Space]act [arrows]move");
          TLab.update_credits2("[drag]rotate   Name:" + flowTracerComponent.nickname);
          var CLab = document.getElementById('handControl').components['shoot-controls'];
          flowTracerComponent.setHandControl(CLab);
          
          // Define the handleSpacePress function
          function handleSpacePress(event) {
            CLab.handleMouseSpacePress(event);
          }

          // Keyboard event listener
          document.addEventListener('keydown', function(event) {
            switch (event.key) {
              case 'p':
                printPosAndRot();
                flowTracerComponent.togglePause();
                console.log("Pausing");
                break;
              case 'a':
                flowTracerComponent.speedUp();
                break;
              case 'b':
                flowTracerComponent.speedDown();
                break;
              case 'm':
                flowTracerComponent.switchInteractionMode();
                break;
              case ' ':
                handleSpacePress(event);
                break;
              default:
                // Do nothing for other keys
                break;
            }
          });
          
// Mouse click event listener for non-touch devices, takes precedence if pointerLock is enabled
document.addEventListener('click', function(event) {
    // Check if pointer lock is active
    if (document.pointerLockElement) {
        // Trigger the desired function
        handleSpacePress(event);
        
        // Prevent default behavior to avoid conflicting actions
        event.preventDefault();
    }
}, true); // Use capturing phase to ensure this listener runs before others


          // Add event listeners to the invisible crosshair button
          var crosshairButton = document.getElementById('crosshair-button');
          
          if (crosshairButton) {
            let touchStartTime = 0;
            const tapThreshold = 300; // milliseconds

            // Handle touchstart
            crosshairButton.addEventListener('touchstart', function(event) {
              touchStartTime = Date.now();
                handleSpacePress(event);
              // Optionally, add visual feedback here
            });

            // Handle touchend
            crosshairButton.addEventListener('touchend', function(event) {
              const touchDuration = Date.now() - touchStartTime;
              if (touchDuration < tapThreshold) {
                handleSpacePress(event);
              }
                handleSpacePress(event);
              // Else, it's a long press; do nothing to allow movement controls
            });

            // Handle click as a fallback for non-touch devices
            crosshairButton.addEventListener('click', function(event) {
              handleSpacePress(event);
                
            });
          } else {
            console.error('Crosshair button not found');
          }

          // Existing mousemove listener
          var mouse = { x: 0, y: 0 };
          document.addEventListener('mousemove', function(event) {
            mouse.x = 0; //(event.clientX / window.innerWidth) * 2 - 1;
            mouse.y = 0; //- (event.clientY / window.innerHeight) * 2 + 1;
            CLab.setMousePosition(mouse, event.clientX, event.clientY);
          });
          
        });
      });
    </script>
  </head>
  <body> 

    <!-- Invisible button overlaying the crosshair -->
    <button id="crosshair-button" aria-label="Activate" tabindex="-1"></button>

    <a-scene id="flowview" arjs='sourceType: webcam; debugUIEnabled: false;' background="color: black"> 
        <!-- renderer="antialias: true" -->

        <a-entity id="surface-current" 
                  flow-tracer="datafile: sample_data/centre.zip; 
                               number_of_particles: 8000; 
                               trail_length: 10;
                               target_advect_per_s: 30; 
                               flowTracerSpeed: 0.5; 
                               raycast_plane: false; 
                               scale: 40000; 
                               demFile: url(sample_data/centre.bin); 
                                dataPointResolutionAlongX: 825.7214672920602;
                                dataPointResolutionAlongY: 1099.663037586159;
                                demColumns: 125;
                                demLines: 100;
                                dataColumns: 125;
                                dataLines: 100;
                                demMax: 2489;
                               demTexture: url(sample_data/centre.jpg); 
                               wireflame: false;
                               zInteractShift: -1;
                               verticalExageration: 2"
                  position="0 1 0">
        </a-entity>
               
   
        
             <a-entity  id="myViewPoint"  movement-controls="fly: true; speed: 0.007" rotation="-80 0 0" position="0 1.50 0" look-controls="pointerLockEnabled: true">
        
                 <a-entity camera position="0 0 0 " rotation="0 0 0" look-controls>
                 
                <a-entity id="timeLabel" 
                      text-info="defaultText: Not loaded" 
                      color="black" 
                      position="0 -0.05 0" 
                      scale="1 1 1" 
                      rotation="0 0 00">
                </a-entity>   
              <!-- Red Crosshair -->
            <a-entity id="Crosshair" 
              geometry="primitive: ring; radiusInner: 0.005; radiusOuter: 0.006" 
              material="color: red; shader: flat" 
              position="0 0 -0.1" 
              rotation="0 0 0">
              

                                <!-- Top Line -->
                    <a-entity 
                      geometry="primitive: box; height: 0.001; width: 0.01; depth: 0.001" 
                      material="color: orange; shader: flat" 
                      position="0.006 0.0 0" 
                      rotation="0 0 0">
                    </a-entity>

                    <!-- Bottom Line -->
                    <a-entity 
                      geometry="primitive: box; height: 0.001; width: 0.01; depth: 0.001" 
                      material="color: orange; shader: flat" 
                      position="-0.006 0 0" 
                      rotation="0 0 0">
                    </a-entity>

                    <!-- Left Line -->
                    <a-entity 
                      geometry="primitive: box; height: 0.01; width: 0.001; depth: 0.001" 
                      material="color: orange; shader: flat" 
                      position="0.00 0.006 0" 
                      rotation="0 0 0">
                    </a-entity>

                    <!-- Right Line -->
                    <a-entity 
                      geometry="primitive: box; height: 0.01; width: 0.001; depth: 0.001" 
                      material="color: orange; shader: flat" 
                      position="0 -0.006 0" 
                      rotation="0 0 0">
                    </a-entity>
                
                
            </a-entity>
           
            </a-entity>
  

                 </a-entity>
                <a-cursor id="handControl" 
                      laser-controls="hand: right" 
                      shoot-controls
                      raycaster="objects: .raycastable; interval: 200"
                      material="color: black; shader: flat"
                      position="0 -0.05 0"
                           scale="1 1 1" 
                      >
            </a-cursor>
    
           </a-entity>
    </a-scene>

  </body>
</html>
