<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Dati e soldi AR</title>
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v7.2.0/dist/aframe-extras.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script src="https://unpkg.com/aframe-terrain-model-component@1.0.1/dist/aframe-terrain-model-component.min.js"></script>
     <script src="js/ARData.js"></script>    
      <script src="js/ar-flow-components.js"></script>
    <script src="js/ar-flow.js"></script>
<script>
  // This function prints the position from the entity with movement-controls and the rotation from the camera
  function printPosAndRot() {
    var movementControlEntity = document.querySelector('[movement-controls]');
    var cameraEl = document.querySelector('a-camera') || document.querySelector('[camera]');
    
    if (movementControlEntity && cameraEl) {
      var position = movementControlEntity.getAttribute('position');
      var rotation = cameraEl.getAttribute('rotation');
      console.log(`<a-entity movement-controls="fly: true; speed: 10" position="${position.x} ${position.y} ${position.z}" rotation="${rotation.x} ${rotation.y} ${rotation.z}" look-controls>\n<a-entity camera position="0 0 0" rotation="0 0 0" look-controls></a-entity>\n</a-entity>`);
    } else {
      console.error('Required entities not found');
    }
  };

  // Example: Call this function when the 'p' key is pressed
  document.addEventListener('DOMContentLoaded', function() {
      
    var sceneEl = document.getElementById('flowview');
    sceneEl.addEventListener('loaded', function() {
      
      var flowTracerComponent = document.getElementById('surface-current').components['flow-tracer'];
      
      console.log("Flow ",flowTracerComponent);
      var TLab = document.getElementById('timeLabel').components['text-info'];
      flowTracerComponent.setTextTracker(TLab);
      TLab.update_credits(" - Keyboard: [p]Pause [m]Mode [Space]Interact");
      TLab.update_credits2("[arrows] move [dragMouse] rotate");
      var CLab = document.getElementById('handControl').components['shoot-controls'];
      flowTracerComponent.setHandControl(CLab);
      
        document.addEventListener('keydown', function(event) {

            if (event.key === 'p') {
                printPosAndRot();
                flowTracerComponent.togglePause();
                console.log("Pausing");
            };
            if (event.key === 'a') {
                flowTracerComponent.speedUp();
            };
            if (event.key === 'b') {
                flowTracerComponent.speedDown();
            };
            if (event.key === 'm') {
                flowTracerComponent.switchInteractionMode()
            };
            if (event.key === ' ') {
                CLab.handleMouseSpacePress(event);
            };

        });
        var mouse = { x: 0, y: 0 };
         document.addEventListener('mousemove', function(event) {
          mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
          mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;
                CLab.setMousePosition(mouse);
          

        });
        
        
     });


});
</script>
  </head>
  <body> 

    <a-scene id="flowview" arjs='sourceType: webcam; debugUIEnabled: false;' background="color: black"> 
        <!-- renderer="antialias: true" -->

        <a-entity id="surface-current" 
                  flow-tracer="datafile: sample_data/centre.zip; 
                               number_of_particles: 8000; 
                               trail_length: 10;
                               target_advect_per_s: 30; 
                               flowTracerSpeed: 0.5; 
                               raycast_plane: false; 
                               scale: 40000; 
                               demFile: url(sample_data/centre.bin); 
                                dataPointResolutionAlongX: 825.7214672920602;
                                dataPointResolutionAlongY: 1099.663037586159;
                                demColumns: 125;
                                demLines: 100;
                                dataColumns: 125;
                                dataLines: 100;
                                demMax: 2489;
                               demTexture: url(sample_data/centre.jpg); 
                               wireflame: false;
                               verticalExageration: 3"
                  position="0 1 0">
        </a-entity>
               
   

        
             <a-entity  id="myViewPoint"  movement-controls="fly: true; speed: 0.03" rotation="-80 0 0" position="0 1.50 0">
        
                 <a-entity camera position="0 0 0 " rotation="0 0 0" look-controls>
                 
                <a-entity id="timeLabel" 
                      text-info="defaultText: Not loaded" 
                      color="black" 
                      position="0 -0.05 0" 
                      scale="1 1 1" 
                      rotation="0 0 00">
                </a-entity>   
  
           
            </a-entity>
  

                 </a-entity>
                <a-cursor id="handControl" 
                      laser-controls="hand: right" 
                      shoot-controls
                      raycaster="objects: .raycastable; interval: 200"
                      material="color: black; shader: flat"
                      position="0 -0.05 0"
                           scale="1 1 1" 
                      >
            </a-cursor>
    
           </a-entity>
    </a-scene>

  </body>
</html>
